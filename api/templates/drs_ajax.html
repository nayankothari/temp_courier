<script>
    var dateInput = document.getElementById('datetime');
    var date = new Date();
    var formattedDate = date.toISOString().split('T')[0];
    dateInput.value = formattedDate;

    $('#area_name').focus();

    // ####################  Get data by docket number only ######################
    $(document).ready(function() {
        $('#docket_number').on('keydown', function(event) {
            if (event.keyCode === 13 || event.keyCode === 9) {
                event.preventDefault();
                var docket_num = $(this).val();
                let csr = $("input[name=csrfmiddlewaretoken").val();
                let drs_doc_data = {
                    'docket_num': docket_num,
                    'csrfmiddlewaretoken': csr
                }
                $.ajax({
                    url: "{% url 'doc_num_from_booking_to_drs' %}",
                    type: "POST",
                    data: drs_doc_data,
                    success: function(response) {
                        if (response.status == 1) {
                            let data = response.data;
                            $("#docket_number").val("");
                            var row = '<tr><td>' + docket_num + '</td><td>' + data.origin + '</td><td> <input type="text" class="form-control con_name" value="' + data.name + '" />' + "</td><td><button type='button' id='myButton' class='border-0 bg-transparent text-primary deleteButton'><i class='bi bi-trash3'></i></button></td></tr>";
                            $('#DrsTable tbody').prepend(row);
                        } else {
                            $('#origin').focus();
                        };
                    }
                });
            }
        });
        // Get automatically number as required.
        $('#docket_number').blur(function(event) {
            event.preventDefault();
            var docket_num = $(this).val();
            let csr = $("input[name=csrfmiddlewaretoken").val();
            let drs_doc_data = {
                'docket_num': docket_num,
                'csrfmiddlewaretoken': csr
            }
            $.ajax({
                url: "{% url 'doc_num_from_booking_to_drs' %}",
                type: "POST",
                data: drs_doc_data,
                success: function(response) {
                    if (response.status == 1) {
                        let data = response.data;
                        $("#docket_number").val("");
                        var row = '<tr><td>' + docket_num + '</td><td>' + data.origin + '</td><td> <input type="text" class="form-control con_name" value="' + data.name + '" />' + "</td><td><button type='button' id='myButton' class='border-0 bg-transparent text-primary deleteButton'><i class='bi bi-trash3'></i></button></td></tr>";
                        $('#DrsTable tbody').prepend(row);
                    } else {
                        $('#origin').focus();
                    };
                }
            });
        })
    });


    // ##################### For delete drs details by html onle ######################

    $('#DrsTable').on('click', '.deleteButton', function() {
        $(this).closest('tr').remove();
        $('#docket_number').focus();
    });


    // ################## Insert default values by consignee name entry #######################
    $(document).ready(function() {
        $('#con_name').on('keydown', function(event) {
            if (event.keyCode === 13 || event.keyCode === 9) {
                event.preventDefault();
                var doc_num = $("#docket_number").val();
                if (doc_num != "") {
                    var origin = $("#origin option:selected").text();
                    var con_name = $("#con_name").val();
                    var row = '<tr><td>' + doc_num + '</td><td>' + origin + '</td><td> <input type="text" class="form-control con_name" value="' + con_name + '" />' + "</td><td><button type='button' id='myButton' class='border-0 bg-transparent text-primary deleteButton'><i class='bi bi-trash3'></i></button></td></tr>";
                    $('#DrsTable tbody').prepend(row);
                    $("#docket_number").val("");
                    $("#con_name").val("");
                    $('#docket_number').focus();
                } else {
                    alert("Insert Docket number");
                    $('#docket_number').focus();
                }
            }
        })
    });

    // ################################## Save DRS Details ####################################
    $("#save_drs").click(function() {
        var drs_history = [];
        $('#DrsTable tr').each(function() {
            var rowData = [];
            $(this).find('th, td').each(function() {
                rowData.push($(this).text());
                let con_names = $(this).find(".con_name").val();
                if (con_names) {
                    rowData.push(con_names);
                };
            });
            rowData.push("");
            rowData.splice(2, 1);
            drs_history.push(rowData);
        });
        let csr = $("input[name=csrfmiddlewaretoken").val();
        let drs_date = $("#datetime").val();
        let area_name = $("#area_name").val();
        let delivery_boy_name = $("#delivery_boy").val();

        let drs_doc_data_final = {
            "drs_history": JSON.stringify(drs_history),
            "csrfmiddlewaretoken": csr,
            "drs_date": drs_date,
            "area_name": area_name,
            "delivery_boy_name": delivery_boy_name
        }
        $.ajax({
            url: "{% url 'save_drs_details' %}",
            type: "POST",
            data: drs_doc_data_final,
            success: function(response) {
                if (response.status == 1) {
                    window.location.href = '/drs'
                } else {
                    alert(response.message);
                };
            }
        });
    });
</script>